<!DOCTYPE HTML>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>ODC2011 - All-Ireland planning application</title>

	<link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.13/themes/base/jquery-ui.css" type="text/css" media="all" />

	<style type="text/css" media="screen">
		@font-face {
		  font-family: 'Crimson Text';
		  font-style: normal;
		  font-weight: normal;
		  src: local('Crimson Text'), local('CrimsonText-Roman'), url('font/CrimsonText-Roman.woff') format('woff');
		}
	
		h2 {
			font-family: 'Crimson Text', serif;
			text-shadow: 2px 2px 2px #aaa;
			padding: 2px;
			margin: 10px;
			border-bottom: 2px solid white;
		}
	
		body { font-family: Verdana,Arial,sans-serif;}
		#mappan {  background: #f0f0f0; border-radius: 4px; -moz-border-radius: 4px; -webkit-border-radius: 4px; border: 1px solid #a0a0a0;}
		#palist { width: 300px; font-size: 80%; padding: .5em; float: left;}
		#mainpan { margin: 0 0 0 320px;}
		#map { text-align: right;}
		#yearpan { width: 40%; float: left;}
		#yearrange { margin: 1em; width: 90%;}
		#yearsel {  width: 100%; background: #f0f0f0; font-size: 200%; border: 0; text-align: center; float: left;}
		#viewselpan { width: 100%; text-align: right; }
		.viewsel-tab { font-size: 200%; 
			padding: 0 1em .5em 1em;
			border: 1px solid #a0a0a0; 
			-webkit-border-bottom-right-radius: 4px;
			-webkit-border-bottom-left-radius: 4px;
			-moz-border-radius-bottomright: 4px;
			-moz-border-radius-bottomleft: 4px;
			border-bottom-right-radius: 4px;
			border-bottom-left-radius: 4px;
			background: #f0f0f0;
			color: #a0a0a0;
			cursor: pointer;
		}
		.viewsel-tab-selected {
			border: 1px solid black; 
			background: white;
			color: black;
		}
		.singlepa { margin: 10px;}
	</style>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js" type="text/javascript"></script>
	<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.13/jquery-ui.min.js" type="text/javascript"></script>
	<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.13/i18n/jquery-ui-i18n.min.js" type="text/javascript"></script>

    <script type="text/javascript">

	var map;
	var mapCenter = new google.maps.LatLng(53.27, -9.104);
	var currentMarkers = new Array();

	// GPlan status based on GPlan_ApplicationStatus.txt
	var APPLICATION_STATUS = {
	 "0":"INCOMPLETED APPLICATION",
	 "1":"NEW APPLICATION",
	 "2":"FURTHER INFORMATION",
	 "3":"DECISION MADE",
	 "4":"LEAVE TO APPEAL",
	 "5":"APPEALED",
	 "8":"WITHDRAWN",
	 "9":"APPLICATION FINALISED",
	 "10":"PRE-VALIDATION",
	 "11":"DEEMED WITHDRAWN",
	 "12":"APPEALED FINANCIAL"
	};

	// this is dummy data, I made it up based on exitings PA, but the schema should be used:
	var data = [
		{appref:'a',lat:53.270,lng:-9.104,appdate:2000,appstatus:8, appdesc:'construct an extension to house'},
		{appref:'b',lat:53.270,lng:-9.104,appdate:2001,appstatus:3, appdesc:'construct extension to house, again'}
	];
	
	function fitMap(){
		$("#mainpan").height($(window).height()*0.9);
		$("#map").width($(window).width()-340);
		$("#map").height($(window).height()*0.6);
	}

	function makemap() {	

		var mapOptions = { 
			zoom: 19,
			center: mapCenter,
			mapTypeId: google.maps.MapTypeId.HYBRID,
			overviewMapControl: true,
			overviewMapControlOptions: {
				position: google.maps.ControlPosition.BOTTOM_RIGHT,
				opened: true
			}
		};

		map = new google.maps.Map(document.getElementById("map"), mapOptions);

		for (i=0; i < data.length; i++) {
			addMarker(data[i]);
		}	
	}
	
	function showSV() {
		var svmap = map.getStreetView();
		svmap.setPosition(mapCenter);
		svmap.setPov({
			heading: 170,
			zoom: 1,
			pitch: 0
		});
		svmap.setVisible(true);
		$("#show-map").removeClass('viewsel-tab-selected');
		$("#show-sv").addClass('viewsel-tab-selected');
	}
	
	function showMap() {
		map.getStreetView().setVisible(false);
		$("#show-sv").removeClass('viewsel-tab-selected');
		$("#show-map").addClass('viewsel-tab-selected');
	}
	

	function addMarker(record) {
		var pos =  getDisplayPosition(record.lat, record.lng);
	
		(function(r) {
			// marker size is 30x32
			var yMarkerImage = new google.maps.MarkerImage("img/year-marker-"+ r.appstatus +"-"+ r.appyear +".png");

			marker = new google.maps.Marker({
				position: pos,
				map: map,
				icon: yMarkerImage,
				title: APPLICATION_STATUS[r.appstatus]
			});
			
			google.maps.event.addListener(marker, "click", function() {
				document.location = '#_' + r.appref;
			});
			
			currentMarkers.push({ id:r.appref, year:r.appyear, marker:marker });
			$("#palist").append("<div class='singlepa'><a href='#" + r.appref + "'>" + record.appdesc + "</a> - " + APPLICATION_STATUS[r.appstatus] + "</div>");
			
		})({'appyear':record.appdate, 'appstatus':record.appstatus, 'appref':record.appref, 'appdesc': record.appdesc});
	}
	
	function getDisplayPosition(lat, lng){
		var pos = new google.maps.LatLng(lat, lng);
		var apos;
		/*
		if(currentMarkers.length > 0) {
			for (var i = 0; i < currentMarkers.length; i++){
				apos = currentMarkers[i].marker.getPosition();
				if(pos.equals(apos)) {
					return new google.maps.LatLng(record.lat + 0.00001, record.lng + 0.00001);
				}
			}
		}
		*/
		return pos;
	}
	
	function yearsel(){
		$("#yearrange").slider({
			range: true,
			min: 2000,
			max: 2010,
			values: [ 2000, 2010 ],
			slide: function(event, ui) {
				$("#yearsel").val(ui.values[0] + " - " + ui.values[1]);
				filterPA(ui.values[0], ui.values[1]);
			}
		});
		
		$("#yearsel").val($("#yearrange").slider("values", 0) + " - " + $("#yearrange").slider("values", 1 ));
		$("#yearsel").attr('readonly', true);
		
	}
	
	function filterPA(miny, maxy){
		for(i in currentMarkers){
			if((currentMarkers[i].year >= miny) && ( currentMarkers[i].year <= maxy)) {
				currentMarkers[i].marker.setVisible(true);
			}
			else {
				currentMarkers[i].marker.setVisible(false);
			}
		}
	}
	

	$(function() { 
		$("#palist").append("<h2>Planning Applications</h2>");
		makemap(); 
		yearsel();
		fitMap();
		$(window).resize(function() {
			fitMap(); 
		});
		
		$("#show-map").click(function() {
			showMap();
		});
		
		$("#show-sv").click(function() {
			showSV();
		});	
		
		
	});
</script>
</head>

<body>
	<div id="mappan">
		<div id="palist"></div>
		<div id="mainpan">
			<div id="map"></div>
			<div id="yearpan">
				Years:
				<div id="yearrange"></div>
				<input id="yearsel" />
			</div>
			<div id="viewselpan">
				<span id="show-map" class="viewsel-tab viewsel-tab-selected">map</span> <span id="show-sv" class="viewsel-tab">street view</span>  
			</div>
		</div>
	</div>	
</body>
</html>
